<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>AI Expense Categorizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --bg-gradient: radial-gradient(
            circle at top left,
            #38bdf8 0,
            transparent 55%
          ),
          radial-gradient(circle at bottom right, #a855f7 0, transparent 55%),
          #020617;
      }
      * {
        box-sizing: border-box;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
      }
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        background-image: var(--bg-gradient);
        background-attachment: fixed;
        color: #e5e7eb;
        display: flex;
        align-items: flex-start;
        justify-content: center;
      }
      .page {
        width: 100%;
        max-width: 1180px;
        padding: 32px 16px 40px;
      }
      .glass {
        background: radial-gradient(
            circle at top left,
            rgba(148, 163, 184, 0.25),
            transparent 55%
          ),
          linear-gradient(
            to bottom right,
            rgba(15, 23, 42, 0.85),
            rgba(15, 23, 42, 0.92)
          );
        border-radius: 24px;
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        padding: 24px 22px 26px;
      }
      @media (min-width: 900px) {
        .glass {
          padding: 26px 26px 28px;
        }
      }
      .header-row {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        align-items: center;
        margin-bottom: 16px;
      }
      h1 {
        font-size: 22px;
        letter-spacing: 0.03em;
        margin: 0 0 4px;
        color: #f9fafb;
      }
      .subtitle {
        color: #9ca3af;
        font-size: 13px;
        margin: 0;
      }
      .badge {
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        padding: 6px 12px;
        font-size: 11px;
        color: #e5e7eb;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(
          to right,
          rgba(15, 23, 42, 0.8),
          rgba(30, 64, 175, 0.7)
        );
      }
      .badge-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 10px rgba(34, 197, 94, 0.65);
      }

      .drop-row {
        margin-top: 18px;
        display: grid;
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr);
        gap: 18px;
      }
      @media (max-width: 900px) {
        .drop-row {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .dropzone {
        border-radius: 18px;
        border: 1px dashed rgba(148, 163, 184, 0.7);
        padding: 28px;
        background: radial-gradient(
            circle at top,
            rgba(59, 130, 246, 0.16),
            transparent 55%
          ),
          rgba(15, 23, 42, 0.82);
        text-align: center;
        cursor: pointer;
        transition: all 0.18s ease;
      }
      .dropzone:hover {
        border-color: rgba(129, 140, 248, 0.9);
        box-shadow: 0 20px 40px rgba(30, 64, 175, 0.35);
        transform: translateY(-1px);
      }
      .dropzone.dragover {
        border-color: #38bdf8;
        background: radial-gradient(
            circle at top,
            rgba(56, 189, 248, 0.22),
            transparent 60%
          ),
          rgba(15, 23, 42, 0.9);
      }
      .drop-main {
        font-size: 15px;
        font-weight: 600;
        color: #e5e7eb;
      }
      .drop-sub {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 4px;
      }
      .pill-file {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.7);
        font-size: 11px;
        color: #e5e7eb;
        margin-top: 10px;
      }

      .side-panel {
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.55);
        background: linear-gradient(
          to bottom right,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.96)
        );
        padding: 18px 18px 16px;
      }
      .side-title {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: #9ca3af;
        margin-bottom: 6px;
      }
      .side-text {
        font-size: 13px;
        color: #e5e7eb;
        margin-bottom: 8px;
      }
      .side-list {
        font-size: 12px;
        color: #9ca3af;
        padding-left: 18px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 9px 18px;
        border-radius: 999px;
        border: none;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        background: linear-gradient(to right, #38bdf8, #6366f1);
        color: white;
        margin-top: 12px;
        box-shadow: 0 10px 30px rgba(56, 189, 248, 0.35);
        transition: transform 0.12s ease, box-shadow 0.12s ease, opacity 0.12s;
      }
      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 16px 40px rgba(56, 189, 248, 0.45);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: default;
        box-shadow: none;
      }

      .status {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 8px;
      }
      .error {
        color: #fca5a5;
      }

      .grid-main {
        display: grid;
        grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
        gap: 18px;
        margin-top: 22px;
      }
      @media (max-width: 960px) {
        .grid-main {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .panel {
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: linear-gradient(
          to bottom right,
          rgba(15, 23, 42, 0.96),
          rgba(15, 23, 42, 0.98)
        );
        padding: 16px 16px 14px;
        box-shadow: 0 16px 40px rgba(15, 23, 42, 0.9);
      }
      .panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
      }
      .panel-title {
        font-size: 14px;
        font-weight: 600;
        color: #e5e7eb;
      }
      .panel-caption {
        font-size: 11px;
        color: #9ca3af;
      }

      .table-wrap {
        max-height: 360px;
        overflow: auto;
        border-radius: 14px;
        border: 1px solid rgba(51, 65, 85, 0.8);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
      }
      thead {
        background: radial-gradient(
          circle at top,
          rgba(30, 64, 175, 0.65),
          rgba(15, 23, 42, 1)
        );
        position: sticky;
        top: 0;
        z-index: 1;
      }
      th,
      td {
        padding: 8px 10px;
        text-align: left;
        border-bottom: 1px solid rgba(30, 41, 59, 0.85);
      }
      th {
        font-weight: 600;
        color: #e5e7eb;
      }
      tbody tr:nth-child(even) td {
        background: rgba(15, 23, 42, 0.9);
      }
      tbody tr:nth-child(odd) td {
        background: rgba(15, 23, 42, 0.96);
      }
      .pill {
        display: inline-flex;
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 11px;
        font-weight: 600;
      }
      .pill-cat {
        background: rgba(56, 189, 248, 0.15);
        color: #7dd3fc;
        border: 1px solid rgba(56, 189, 248, 0.45);
      }
      .pill-conf {
        background: rgba(34, 197, 94, 0.12);
        color: #bbf7d0;
        border: 1px solid rgba(34, 197, 94, 0.4);
      }

      .summary-card {
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.65);
        background: radial-gradient(
            circle at top,
            rgba(56, 189, 248, 0.16),
            transparent 60%
          ),
          rgba(15, 23, 42, 0.96);
        padding: 14px 14px 12px;
      }
      .summary-label {
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 4px;
      }
      .summary-headline {
        font-size: 13px;
        color: #e5e7eb;
        margin-bottom: 10px;
      }
      .summary-total {
        font-size: 13px;
        color: #e5e7eb;
        margin-bottom: 8px;
      }
      .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        color: #cbd5f5;
        margin-bottom: 3px;
      }

      .charts-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 10px;
        margin-top: 10px;
      }
      .chart-card {
        border-radius: 14px;
        border: 1px solid rgba(51, 65, 85, 0.85);
        background: radial-gradient(
            circle at top left,
            rgba(56, 189, 248, 0.16),
            transparent 55%
          ),
          rgba(15, 23, 42, 0.98);
        padding: 10px;
      }
      .chart-title {
        font-size: 11px;
        color: #9ca3af;
        margin-bottom: 2px;
      }

      .footer-tip {
        margin-top: 12px;
        font-size: 11px;
        color: #9ca3af;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="glass">
        <div class="header-row">
          <div>
            <h1>AI Expense Categorizer</h1>
            <p class="subtitle">
              Drag in your bank CSV and let the model tag categories, summarize
              spend, and visualize where your money goes.
            </p>
          </div>
          <div class="badge">
            <span class="badge-dot"></span>
            <span>AI-powered Â· Local dashboard</span>
          </div>
        </div>

        <div class="drop-row">
          <div>
            <div id="dropzone" class="dropzone">
              <p class="drop-main">
                <strong>Drag & drop</strong> your CSV file here
              </p>
              <p class="drop-sub">
                or click to browse Â· Format: Date, Description, Amount
              </p>
              <input
                id="file-input"
                type="file"
                accept=".csv"
                style="display: none"
              />
              <div id="file-pill" class="pill-file" style="display: none">
                <span>ðŸ“„ <span id="file-name">file.csv</span></span>
              </div>
            </div>
            <button id="analyze-btn" class="btn" disabled>
              Analyze with AI
            </button>
            <div id="status" class="status"></div>
          </div>

          <div class="side-panel">
            <div class="side-title">How it works</div>
            <p class="side-text">
              1. CSV is parsed locally with Python<br />
              2. Only <strong>Date, Description, Amount</strong> go to the
              model<br />
              3. AI predicts a category + confidence for each row<br />
              4. Dashboard updates instantly with insights & charts
            </p>
            <div class="side-title" style="margin-top: 8px">Categories</div>
            <ul class="side-list">
              <li>Groceries, Food & Dining</li>
              <li>Transportation, Travel</li>
              <li>Shopping, Entertainment</li>
              <li>Rent, Bills & Utilities</li>
              <li>Subscriptions, Other</li>
            </ul>
          </div>
        </div>

        <div id="results" style="display: none">
          <div class="grid-main">
            <div class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Categorized transactions</div>
                  <div class="panel-caption">
                    AI-labeled rows with category + confidence
                  </div>
                </div>
              </div>
              <div class="table-wrap">
                <table id="results-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Description</th>
                      <th>Amount</th>
                      <th>Category</th>
                      <th>Confidence</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>

            <div class="panel">
              <div class="panel-header">
                <div>
                  <div class="panel-title">Spending overview</div>
                  <div class="panel-caption">
                    Automatically generated from categorized data
                  </div>
                </div>
              </div>
              <div id="summary-card" class="summary-card">
                <div>
                  <p class="summary-label">Headline</p>
                  <p id="headline" class="summary-headline"></p>
                </div>
                <div>
                  <p class="summary-label">Total spent</p>
                  <p id="total-spent" class="summary-total"></p>
                </div>
                <div>
                  <p class="summary-label">By category</p>
                  <div id="by-category"></div>
                </div>

                <div class="charts-grid">
                  <div class="chart-card">
                    <div class="chart-title">Spend by category (bar)</div>
                    <canvas id="barChart" height="140"></canvas>
                  </div>
                  <div class="chart-card">
                    <div class="chart-title">Spend breakdown (pie)</div>
                    <canvas id="pieChart" height="140"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const dropzone = document.getElementById("dropzone");
      const fileInput = document.getElementById("file-input");
      const analyzeBtn = document.getElementById("analyze-btn");
      const statusEl = document.getElementById("status");
      const filePill = document.getElementById("file-pill");
      const fileNameEl = document.getElementById("file-name");
      const resultsEl = document.getElementById("results");
      const resultsTableBody = document.querySelector("#results-table tbody");
      const headlineEl = document.getElementById("headline");
      const totalSpentEl = document.getElementById("total-spent");
      const byCategoryEl = document.getElementById("by-category");

      let selectedFile = null;
      let barChart = null;
      let pieChart = null;

      dropzone.addEventListener("click", () => fileInput.click());

      fileInput.addEventListener("change", (e) => {
        if (e.target.files && e.target.files[0]) {
          selectedFile = e.target.files[0];
          onFileSelected(selectedFile);
        }
      });

      function onFileSelected(file) {
        statusEl.textContent = "Selected: " + file.name;
        statusEl.classList.remove("error");
        analyzeBtn.disabled = false;
        fileNameEl.textContent = file.name;
        filePill.style.display = "inline-flex";
      }

      dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("dragover");
      });

      dropzone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        dropzone.classList.remove("dragover");
      });

      dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files && files[0]) {
          selectedFile = files[0];
          onFileSelected(selectedFile);
        }
      });

      analyzeBtn.addEventListener("click", async () => {
        if (!selectedFile) return;
        analyzeBtn.disabled = true;
        statusEl.textContent = "Analyzing with AI...";
        statusEl.classList.remove("error");

        const formData = new FormData();
        formData.append("file", selectedFile);

        try {
          const res = await fetch("/api/categorize", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (!res.ok) {
            throw new Error(data.error || "Unknown error");
          }

          renderResults(data);
          statusEl.textContent = "Done!";
        } catch (err) {
          console.error(err);
          statusEl.textContent = "Error: " + err.message;
          statusEl.classList.add("error");
        } finally {
          analyzeBtn.disabled = false;
        }
      });

      function renderResults(data) {
        resultsEl.style.display = "block";
        resultsTableBody.innerHTML = "";

        (data.transactions || []).forEach((row) => {
          const tr = document.createElement("tr");

          const tdDate = document.createElement("td");
          tdDate.textContent = row.Date;
          tr.appendChild(tdDate);

          const tdDesc = document.createElement("td");
          tdDesc.textContent = row.Description;
          tr.appendChild(tdDesc);

          const tdAmount = document.createElement("td");
          tdAmount.textContent = row.Amount;
          tr.appendChild(tdAmount);

          const tdCat = document.createElement("td");
          const catSpan = document.createElement("span");
          catSpan.className = "pill pill-cat";
          catSpan.textContent = row.Category || "Unknown";
          tdCat.appendChild(catSpan);
          tr.appendChild(tdCat);

          const tdConf = document.createElement("td");
          const confSpan = document.createElement("span");
          confSpan.className = "pill pill-conf";
          const conf =
            row.Confidence != null ? Number(row.Confidence).toFixed(2) : "â€”";
          confSpan.textContent = conf;
          tdConf.appendChild(confSpan);
          tr.appendChild(tdConf);

          resultsTableBody.appendChild(tr);
        });

        const summary = data.summary || {};
        headlineEl.textContent = summary.headline || "";
        totalSpentEl.textContent =
          summary.total_spent != null
            ? "$" + summary.total_spent.toFixed(2)
            : "â€”";

        byCategoryEl.innerHTML = "";
        const byCat = summary.by_category || {};
        const labels = [];
        const values = [];
        Object.keys(byCat).forEach((cat) => {
          labels.push(cat);
          values.push(byCat[cat]);
          const row = document.createElement("div");
          row.className = "summary-row";
          const name = document.createElement("span");
          name.textContent = cat;
          const val = document.createElement("span");
          val.textContent = "$" + byCat[cat].toFixed(2);
          row.appendChild(name);
          row.appendChild(val);
          byCategoryEl.appendChild(row);
        });

        renderCharts(labels, values);
      }

      function renderCharts(labels, values) {
        const barCtx = document.getElementById("barChart").getContext("2d");
        const pieCtx = document.getElementById("pieChart").getContext("2d");

        if (barChart) barChart.destroy();
        if (pieChart) pieChart.destroy();

        barChart = new Chart(barCtx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Amount",
                data: values,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: {
                ticks: { color: "#9ca3af", font: { size: 10 } },
                grid: { color: "rgba(55,65,81,0.6)" },
              },
              y: {
                ticks: { color: "#9ca3af", font: { size: 10 } },
                grid: { color: "rgba(55,65,81,0.6)" },
              },
            },
          },
        });

        pieChart = new Chart(pieCtx, {
          type: "pie",
          data: {
            labels: labels,
            datasets: [
              {
                data: values,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#e5e7eb", font: { size: 10 } },
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
